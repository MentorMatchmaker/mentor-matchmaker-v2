<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor Matchmaker - Challenge Sandwich Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-light': '#7B7AE8',
                        'primary-dark': '#4A49C2'
                    }
                }
            }
        }
    </script>
    <style>
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator { animation: pulse 1.5s infinite; }
        .markdown-content h3 { font-weight: 600; font-size: 1.125rem; margin: 1rem 0 0.5rem 0; }
        .markdown-content p { margin: 0.5rem 0; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5rem; margin: 0.5rem 0; }
        .markdown-content strong { font-weight: 600; }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 transition-colors duration-200">
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList[event.matches ? 'add' : 'remove']('dark');
        });
    </script>

    <div class="min-h-screen flex flex-col">
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-4">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-primary to-primary-light rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">MM</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">Mentor Matchmaker</h1>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Challenge Sandwich Framework</p>
                    </div>
                </div>
                <button onclick="resetSession()" class="text-sm text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">
                    Start Over
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div class="flex-1 overflow-y-auto px-4 py-6" id="chatContainer">
                    <div class="space-y-6" id="chatMessages"></div>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-4 bg-white dark:bg-gray-800">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <textarea
                                id="userInput"
                                placeholder="Type your response here..."
                                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                rows="2"
                                maxlength="1000"
                            ></textarea>
                        </div>
                        <button
                            id="sendButton"
                            onclick="sendMessage()"
                            class="px-6 py-3 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Send
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                        Press Enter to send ‚Ä¢ <span id="charCount">0</span>/1000 characters
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="sandwichModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Your Challenge Sandwich</h2>
                    <button onclick="closeSandwichModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="sandwichContent" class="space-y-6"></div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="copySandwich()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                        Copy to Clipboard
                    </button>
                    <button onclick="downloadSandwich()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationState = {
            phase: 'welcome',
            conversationHistory: [],
            completeSandwich: null
        };
        let isWaitingForResponse = false;

        function initializeApp() {
            setupEventListeners();
            showWelcomeMessage();
        }

        function setupEventListeners() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');

            userInput.addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
                sendButton.disabled = this.value.trim() === '' || isWaitingForResponse;
            });

            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function showWelcomeMessage() {
            const welcomeMessage = `Hello! I'm the Mentor Matchmaker. I'm going to help you find a great mentor using a proven framework called the 'Challenge Sandwich.' We'll work together to build yours.

**What is a specific professional challenge you'd like to solve in the next 60 days?**

It could be landing a new role, validating a business idea, or learning a key skill. Don't worry about making it perfect; we'll refine it together.`;
            addMessage('assistant', welcomeMessage);
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message || isWaitingForResponse) return;

            addMessage('user', message);
            conversationState.conversationHistory.push({role: 'user', content: message});
            
            userInput.value = '';
            userInput.style.height = 'auto';
            document.getElementById('charCount').textContent = '0';

            isWaitingForResponse = true;
            updateSendButton();
            addMessage('assistant', '', true);

            try {
                const systemPrompt = `You are Brian Leor Frankel having a one-on-one coaching conversation. You wrote "How to Find a Mentor" and you're personally helping this person build their Challenge Sandwich.

CONVERSATION RULES:
- Keep responses SHORT (2-3 sentences max)
- Focus on ONE thing at a time
- Be helpful but not overwhelming
- Give users control to move forward when ready

CONVERSATION FLOW:

PHASE 1 - CHALLENGE REFINEMENT:
- Help make it specific, measurable, achievable in 60 days
- Give your refined suggestion FIRST, then ask: "How does that sound to you?"
- Example: "Let's make it more specific: 'Launch a mobile budgeting app MVP and get 100 beta users within 60 days.' How does that sound to you?"

PHASE 2 - GAME PLAN DEVELOPMENT (KEEP IT MANAGEABLE):
- Ask: "What's your plan to tackle this challenge? Give me 2-3 steps you're thinking."
- If they ask for suggestions: Give 2-3 concrete suggestions and say "What do you think of those steps?"
- If they give vague steps: Suggest ONE more specific version and ask "Does that work better?"
- Accept when they're satisfied: If they say "that works" or "sounds good," move on
- Allow them to say they're done: If they seem overwhelmed, let them move forward
- Don't keep pushing for more depth - save detailed planning for later

PHASE 3 - BACKGROUND DISCOVERY:
- Ask: "Now let's talk about what you've accomplished lately. What have you done in the past 6 months that shows you're making progress?"
- If modest: "What projects have you worked on? What results did you see?"
- Help frame with impact: "Let's highlight that - you increased X by Y% and led Z project."
- Ask: "What strengths do people recognize in you?"
- If they struggle: "What do colleagues come to you for help with?"

PHASE 4 - FINAL SANDWICH:
- Present complete Challenge Sandwich with quality score

COACHING STYLE:
- Give suggestion FIRST, then ask for feedback
- Don't overwhelm with too many follow-up questions
- Let users control the pace
- Accept "good enough" and move forward
- Say things like: "Perfect, let's move on to..." when they're ready

Remember: Be thorough but not overwhelming. Let them drive the conversation forward when they're satisfied.`;

                const messages = [
                    {role: 'system', content: systemPrompt},
                    ...conversationState.conversationHistory.slice(-8),
                    {role: 'user', content: message}
                ];

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                conversationState.conversationHistory.push({role: 'assistant', content: assistantMessage});
                updateLastAssistantMessage(assistantMessage);
                checkForSandwichCompletion(assistantMessage);

            } catch (error) {
                updateLastAssistantMessage(`‚ùå Sorry, I'm having trouble connecting. Please try again.`);
            }

            isWaitingForResponse = false;
            updateSendButton();
        }

        function addMessage(sender, content, isLoading = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';

            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex justify-end mb-4">
                        <div class="max-w-3xl bg-primary text-white rounded-lg px-4 py-3">
                            <div class="whitespace-pre-wrap">${escapeHtml(content)}</div>
                        </div>
                    </div>`;
            } else {
                const contentHtml = isLoading ? 
                    '<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div><div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div><span class="ml-2 text-primary">Thinking...</span></div>' :
                    `<div class="markdown-content">${marked.parse(content)}</div>`;

                messageDiv.innerHTML = `
                    <div class="flex justify-start mb-4">
                        <div class="max-w-3xl bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-3">
                            ${contentHtml}
                        </div>
                    </div>`;
            }

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function updateLastAssistantMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            const lastMessage = chatMessages.lastElementChild;
            
            if (lastMessage && lastMessage.querySelector('.bg-gray-100, .bg-gray-700')) {
                const contentDiv = lastMessage.querySelector('.bg-gray-100, .bg-gray-700');
                contentDiv.innerHTML = `<div class="markdown-content">${marked.parse(content)}</div>`;
                scrollToBottom();
            }
        }

        function checkForSandwichCompletion(content) {
            if (content.includes('Challenge Sandwich') && content.includes('complete')) {
                extractSandwichFromContent(content);
            }
        }

        function extractSandwichFromContent(content) {
            const lines = content.split('\n');
            let challenge = '', gameplan = '', background = '';
            let currentSection = '';

            for (let line of lines) {
                if (line.includes('Challenge:') || line.includes('60-Day Challenge:')) {
                    currentSection = 'challenge';
                } else if (line.includes('Game Plan:') || line.includes('Secret Sauce:')) {
                    currentSection = 'gameplan';
                } else if (line.includes('Background:') || line.includes('Bread:')) {
                    currentSection = 'background';
                } else if (currentSection && line.trim() && !line.includes('**')) {
                    if (currentSection === 'challenge') challenge += line.trim() + '\n';
                    else if (currentSection === 'gameplan') gameplan += line.trim() + '\n';
                    else if (currentSection === 'background') background += line.trim() + '\n';
                }
            }

            if (challenge && gameplan && background) {
                conversationState.completeSandwich = {
                    challenge: challenge.trim(),
                    gameplan: gameplan.trim(),
                    background: background.trim()
                };
                setTimeout(() => showSandwichModal(), 1000);
            }
        }

        function showSandwichModal() {
            const modal = document.getElementById('sandwichModal');
            const content = document.getElementById('sandwichContent');
            const sandwich = conversationState.completeSandwich;

            if (!sandwich) return;

            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">ü•© The Meat: Your 60-Day Challenge</h3>
                        <p class="text-blue-800 dark:text-blue-200">${escapeHtml(sandwich.challenge)}</p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-900 dark:text-green-100 mb-2">ü•Ñ The Secret Sauce: Your Game Plan</h3>
                        <div class="text-green-800 dark:text-green-200 whitespace-pre-wrap">${escapeHtml(sandwich.gameplan)}</div>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-900 dark:text-purple-100 mb-2">üçû The Bread: Your Background</h3>
                        <div class="text-purple-800 dark:text-purple-200 whitespace-pre-wrap">${escapeHtml(sandwich.background)}</div>
                    </div>
                </div>`;

            modal.classList.remove('hidden');
        }

        function closeSandwichModal() {
            document.getElementById('sandwichModal').classList.add('hidden');
        }

        function copySandwich() {
            const sandwich = conversationState.completeSandwich;
            if (!sandwich) return;

            const text = `MY CHALLENGE SANDWICH

ü•© The Meat: 60-Day Challenge
${sandwich.challenge}

ü•Ñ The Secret Sauce: Game Plan
${sandwich.gameplan}

üçû The Bread: Background
${sandwich.background}

---
Created with the Mentor Matchmaker Challenge Sandwich Framework
By Brian Leor Frankel - "How to Find a Mentor"`;

            navigator.clipboard.writeText(text).then(() => {
                showTemporaryMessage(event.target, 'Copied!', 'bg-green-600');
            });
        }

        function downloadSandwich() {
            const sandwich = conversationState.completeSandwich;
            if (!sandwich) return;

            const content = `MY CHALLENGE SANDWICH

ü•© The Meat: 60-Day Challenge
${sandwich.challenge}

ü•Ñ The Secret Sauce: Game Plan  
${sandwich.gameplan}

üçû The Bread: Background
${sandwich.background}

---
Created with the Mentor Matchmaker Challenge Sandwich Framework
By Brian Leor Frankel - "How to Find a Mentor"
MentorMatchmaker.com`;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-challenge-sandwich.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showTemporaryMessage(event.target, 'Downloaded!', 'bg-green-600');
        }

        function showTemporaryMessage(button, message, bgClass) {
            const originalText = button.textContent;
            const originalClass = button.className;
            button.textContent = message;
            button.className = button.className.replace('bg-primary', bgClass).replace('bg-green-600', bgClass);
            setTimeout(() => {
                button.textContent = originalText;
                button.className = originalClass;
            }, 2000);
        }

        function updateSendButton() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            
            sendButton.disabled = userInput.value.trim() === '' || isWaitingForResponse;
            sendButton.textContent = isWaitingForResponse ? 'Thinking...' : 'Send';
        }

        function resetSession() {
            conversationState = { phase: 'welcome', conversationHistory: [], completeSandwich: null };
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('userInput').value = '';
            document.getElementById('charCount').textContent = '0';
            isWaitingForResponse = false;
            updateSendButton();
            showWelcomeMessage();
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
